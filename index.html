<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>A√ß√£o Pro ¬∑ M√∫ltiplos sorteios</title>
    <!-- Dexie -->
    <script src="https://unpkg.com/dexie@3.2.3/dist/dexie.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 10px;
        }

        .app {
            max-width: 480px;
            width: 100%;
            background: #ffffff;
            border-radius: 32px 32px 24px 24px;
            box-shadow: 0 20px 40px rgba(0, 20, 50, 0.12);
            overflow: hidden;
            padding: 20px 14px 24px;
        }

        .header-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        h1 {
            font-size: 1.9rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: #1a2b3c;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .gear-btn {
            background: #eef2f6;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            color: #1e3b5c;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .gear-btn:hover {
            background: #e2eaf3;
            transform: rotate(30deg);
        }

        .badge {
            background: #c9a03d;
            color: #ffffff;
            font-size: 0.75rem;
            padding: 5px 14px;
            border-radius: 40px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            background: #eef2f6;
            padding: 5px;
            border-radius: 60px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-weight: 600;
            color: #4a5e72;
            border-radius: 50px;
            transition: 0.2s;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .tab.active {
            background: #ffffff;
            color: #1e3b5c;
            box-shadow: 0 4px 10px rgba(0, 60, 130, 0.12);
            font-weight: 700;
        }

        .stats {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
        }

        .stat {
            flex: 1;
            background: #f8fbfe;
            border-radius: 28px;
            padding: 16px 4px;
            text-align: center;
            border: 1px solid #e2e9f2;
        }

        .stat .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #5a6f88;
            letter-spacing: 0.4px;
        }

        .stat .value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1a2b3c;
            line-height: 1.2;
        }

        .stat.destacado {
            background: #e9eff9;
            border-color: #b8cbe0;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .search {
            flex: 2;
            min-width: 160px;
            background: #f2f6fc;
            border-radius: 50px;
            padding: 4px 4px 4px 16px;
            display: flex;
            align-items: center;
            border: 1px solid #d4deec;
        }

        .search span {
            font-size: 1.1rem;
            opacity: 0.6;
            margin-right: 4px;
        }

        .search input {
            border: none;
            background: transparent;
            padding: 12px 0;
            width: 100%;
            font-size: 0.95rem;
        }

        .search input:focus {
            outline: none;
        }

        .filter-month {
            flex: 1;
            background: #f2f6fc;
            border-radius: 50px;
            padding: 0 4px 0 16px;
            display: flex;
            align-items: center;
            border: 1px solid #d4deec;
        }

        .filter-month select {
            background: transparent;
            border: none;
            padding: 12px 0;
            font-size: 0.9rem;
            width: 100%;
            font-weight: 500;
            color: #1e3b5c;
        }

        .filter-month select:focus {
            outline: none;
        }

        .btn-add {
            background: #1e3b5c;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 16px 20px;
            border-radius: 60px;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 12px 24px -8px #1e3b5cb3;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 440px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .participant-card {
            background: #ffffff;
            border-radius: 24px;
            padding: 16px 14px;
            border: 1px solid #e3eaf2;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }

        .part-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 6px;
            flex-wrap: wrap;
        }

        .part-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1a2b3c;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .group-badge {
            background: #e0e8f2;
            color: #1e3b5c;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 40px;
            white-space: nowrap;
        }

        .part-number {
            background: #1e3b5c;
            color: white;
            padding: 5px 16px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .part-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 10px;
            margin-bottom: 14px;
            color: #3c556e;
            font-weight: 500;
            align-items: center;
        }

        .part-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #f0f4fa;
            padding: 5px 14px;
            border-radius: 40px;
            font-size: 0.85rem;
        }

        .status-pago {
            background: #d9e9dd;
            color: #1e6f3f;
            font-weight: 600;
        }

        .status-naopago {
            background: #fdeae5;
            color: #b13e2d;
        }

        .part-date {
            font-size: 0.8rem;
            color: #5f748e;
        }

        .part-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            border-top: 1px dashed #dae1ea;
            padding-top: 14px;
            flex-wrap: wrap;
        }

        .btn-action {
            background: transparent;
            border: 1.5px solid #cbd5e3;
            padding: 10px 12px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.8rem;
            color: #1e3b5c;
            cursor: pointer;
            flex: 1 0 70px;
            white-space: nowrap;
        }

        .btn-action.pagar {
            background: #1e3b5c;
            border-color: #1e3b5c;
            color: white;
        }

        .btn-action:disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Estilos para relat√≥rios por a√ß√£o */
        .relatorio-acoes {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        .acao-relatorio-card {
            background: #ffffff;
            border-radius: 24px;
            padding: 18px;
            border: 1px solid #dee7f2;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }
        .acao-relatorio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .acao-relatorio-nome {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e3b5c;
        }
        .acao-relatorio-status {
            font-size: 0.7rem;
            padding: 4px 12px;
            border-radius: 40px;
            background: #e0e8f2;
            color: #1e3b5c;
        }
        .acao-relatorio-status.disponivel {
            background: #d9e9dd;
            color: #1e6f3f;
        }
        .acao-relatorio-detalhes {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #3c556e;
            flex-wrap: wrap;
        }
        .acao-relatorio-total {
            font-weight: 700;
            color: #1e3b5c;
        }
        .acao-relatorio-participantes {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            border-top: 1px dashed #dae1ea;
            padding-top: 10px;
        }
        .acao-participante-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eef2f6;
            font-size: 0.9rem;
        }
        .btn-relatorio-pdf {
            background: #ffffff;
            border: 1.5px solid #1e3b5c;
            color: #1e3b5c;
            font-weight: 600;
            padding: 12px;
            border-radius: 60px;
            width: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
        }
        .btn-relatorio-pdf:hover {
            background: #1e3b5c;
            color: white;
        }

        .relatorio-mensal {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .month-block {
            background: #f9fcff;
            border-radius: 24px;
            padding: 16px;
            border: 1px solid #dee7f2;
        }

        .month-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a2b3c;
            margin-bottom: 6px;
        }

        .month-total {
            font-size: 1.8rem;
            font-weight: 800;
            color: #1e3b5c;
            margin-bottom: 10px;
        }

        .month-participants {
            list-style: none;
        }

        .month-participants li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e8f2;
            font-size: 0.9rem;
            gap: 8px;
        }

        .month-participants li:last-child {
            border-bottom: none;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            margin: 20px 0 10px;
            flex-wrap: wrap;
        }
        .btn-report {
            flex: 1;
            background: #ffffff;
            border: 1.5px solid #1e3b5c;
            color: #1e3b5c;
            font-weight: 600;
            padding: 14px 8px;
            border-radius: 60px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
        }
        .btn-report:hover {
            background: #1e3b5c;
            color: white;
        }

        /* MODAIS */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,20,40,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .modal {
            background: white;
            border-radius: 36px;
            max-width: 440px;
            width: 100%;
            padding: 28px 20px;
            box-shadow: 0 30px 50px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a2b3c;
            margin-bottom: 18px;
        }

        .modal .config-row {
            margin-bottom: 16px;
        }
        .modal .config-row label {
            font-weight: 600;
            color: #2c4058;
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        .modal .config-row input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 40px;
            border: 1.5px solid #d0dae8;
            font-size: 0.95rem;
            background: #f9fcff;
        }
        .modal .config-row select {
            width: 100%;
            padding: 14px 16px;
            border-radius: 40px;
            border: 1.5px solid #d0dae8;
            font-size: 0.95rem;
            background: #f9fcff;
        }
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .checkbox-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .btn-primary, .btn-secondary, .btn-fechar, .btn-danger {
            border: none;
            padding: 14px;
            border-radius: 60px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .btn-primary {
            background: #1e3b5c;
            color: white;
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #1e3b5c;
        }
        .btn-danger {
            background: #b13e2d;
            color: white;
        }
        .btn-fechar {
            background: #1a314a;
            color: white;
            width: 100%;
            margin-top: 12px;
        }

        .backup-btn {
            background: #eef2f6;
            border: 1px solid #cbd5e3;
            color: #1e3b5c;
            font-weight: 600;
            padding: 14px;
            border-radius: 60px;
            font-size: 0.9rem;
            cursor: pointer;
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
        }
        .backup-btn.import {
            background: #ffffff;
            border-color: #1e3b5c;
        }

        .acoes-list {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .acao-item {
            background: #f9fcff;
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #dee7f2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .acao-info {
            flex: 1;
        }
        .acao-nome {
            font-weight: 700;
            color: #1e3b5c;
        }
        .acao-detalhes {
            font-size: 0.8rem;
            color: #5f748e;
        }
        .acao-status {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 40px;
            background: #e0e8f2;
            color: #1e3b5c;
            margin-left: 8px;
        }
        .acao-status.disponivel {
            background: #d9e9dd;
            color: #1e6f3f;
        }
        .acao-actions button {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 5px;
        }

        .receipt-modern {
            background: #ffffff;
            border-radius: 28px;
            padding: 24px 20px;
            border: 1px solid #dbe4f0;
            box-shadow: 0 10px 24px -8px rgba(0,32,64,0.15);
            margin: 10px 0;
        }
        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
        }
        .receipt-header h4 {
            font-size: 1.8rem;
            font-weight: 800;
            color: #1a2b3c;
            letter-spacing: -0.5px;
        }
        .receipt-badge {
            background: #1e3b5c;
            color: white;
            padding: 6px 18px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .receipt-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 16px;
        }
        .receipt-item {
            border-bottom: 1px dashed #cdd9e9;
            padding-bottom: 8px;
        }
        .receipt-item .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #5f748e;
            letter-spacing: 0.3px;
        }
        .receipt-item .value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #0b1c2c;
            word-break: break-word;
        }
        .receipt-total {
            grid-column: span 2;
            background: #f0f6ff;
            border-radius: 18px;
            padding: 14px;
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            font-size: 1.2rem;
            margin-top: 10px;
        }

        .modal-add {
            background: #ffffff;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1e3b5c;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .input-group label i {
            font-size: 1.2rem;
        }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 16px 18px;
            border-radius: 24px;
            border: 2px solid #e0e8f2;
            font-size: 1rem;
            background: #f9fcff;
            transition: 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            border-color: #1e3b5c;
            outline: none;
            background: #ffffff;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .hint {
            font-size: 0.8rem;
            color: #5f748e;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .modal-actions button {
            flex: 1;
            padding: 16px;
            border-radius: 40px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-save {
            background: #1e3b5c;
            color: white;
            box-shadow: 0 8px 16px -4px #1e3b5c80;
        }
        .btn-cancel {
            background: #eef2f6;
            color: #1e3b5c;
            border: 1px solid #cbd5e3;
        }

        .empty-message {
            text-align: center;
            padding: 36px 0;
            color: #7d8fa4;
            font-weight: 500;
        }

        footer {
            font-size: 0.7rem;
            color: #9aadc2;
            text-align: center;
            margin-top: 20px;
        }

        .text-small {
            font-size: 0.8rem;
            color: #5f748e;
        }

        .file-input {
            display: none;
        }

        @media (max-width: 360px) {
            .app { padding: 16px 10px; }
            .stat .value { font-size: 1.3rem; }
        }
    </style>
</head>
<body>
<div class="app">
    <div class="header-flex">
        <h1>üéüÔ∏è A√ß√£o<span class="badge">PRO</span></h1>
        <button class="gear-btn" id="gearBtn" title="Configura√ß√µes e backup">‚öôÔ∏è</button>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="participantes">Participantes</div>
        <div class="tab" data-tab="relatorio">Relat√≥rio</div>
    </div>

    <div id="tabParticipantes" style="display: block;">
        <div class="stats">
            <div class="stat">
                <div class="label">n√∫meros</div>
                <div class="value" id="totalNumeros">0</div>
            </div>
            <div class="stat">
                <div class="label">arrecadado</div>
                <div class="value" id="totalArrecadado">R$0</div>
            </div>
            <div class="stat destacado">
                <div class="label" id="monthLabel">m√™s atual</div>
                <div class="value" id="totalMes">R$0</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="search">
                <span>üîç</span>
                <input type="text" id="searchInput" placeholder="Buscar nome...">
            </div>
            <div class="filter-month">
                <select id="monthFilter">
                    <option value="todos">Todos os meses</option>
                </select>
            </div>
        </div>

        <button class="btn-add" id="btnAdicionar">‚ûï Adicionar n√∫meros</button>

        <div class="participant-list" id="participantList">
            <div class="empty-message">Nenhum n√∫mero cadastrado.</div>
        </div>
    </div>

    <div id="tabRelatorio" style="display: none;">
        <div class="card" style="border: none; padding:0;">
            <h2 style="margin-bottom:16px;">üìÜ Relat√≥rio mensal (m√™s da a√ß√£o)</h2>
            <div id="relatorioContainer" class="relatorio-mensal"></div>
            
            <h2 style="margin:30px 0 16px;">üéØ Relat√≥rio por A√ß√£o</h2>
            <div id="relatorioAcoesContainer" class="relatorio-acoes"></div>
            
            <div class="report-actions">
                <button class="btn-report" id="exportMensalPDF">üìÑ Exportar m√™s atual</button>
                <button class="btn-report" id="exportCompletoPDF">üìä Exportar completo</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE CONFIGURA√á√ïES (gerenciar a√ß√µes) -->
    <div id="configModal" class="modal-overlay">
        <div class="modal">
            <h3>‚öôÔ∏è Gerenciar A√ß√µes</h3>
            <div id="acoesList" class="acoes-list"></div>
            
            <h4 style="margin: 20px 0 10px;">Nova A√ß√£o</h4>
            <div class="config-row">
                <label>Nome da A√ß√£o</label>
                <input type="text" id="novaAcaoNome" placeholder="Ex: A√ß√£o Pro 3 Ano">
            </div>
            <div class="config-row">
                <label>Pr√™mio</label>
                <input type="text" id="novaAcaoPremio" placeholder="Ex: Smartphone">
            </div>
            <div class="config-row">
                <label>Data do sorteio</label>
                <input type="date" id="novaAcaoData">
            </div>
            <div class="config-row">
                <label>Valor da cota (R$)</label>
                <input type="number" id="novaAcaoValor" step="0.01" min="0.01" value="5.00">
            </div>
            <div class="checkbox-row">
                <input type="checkbox" id="novaAcaoDisponivel" checked>
                <label for="novaAcaoDisponivel">Dispon√≠vel para venda</label>
            </div>
            <button class="btn-primary" id="btnAdicionarAcao" style="width:100%; margin-bottom:20px;">‚ûï Adicionar A√ß√£o</button>

            <h3 style="font-size:1.4rem; margin:10px 0 16px;">üíæ Backup</h3>
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <button class="backup-btn" id="exportBackup">üì§ Exportar</button>
                <button class="backup-btn import" id="importBackup">üì• Importar</button>
            </div>
            <input type="file" id="fileInput" accept=".json" class="file-input">

            <button class="btn-secondary" id="fecharConfigModal" style="width:100%; margin-top:20px;">Fechar</button>
        </div>
    </div>

    <!-- MODAL DE RECIBO -->
    <div id="reciboModal" class="modal-overlay">
        <div class="modal">
            <h3>üßæ Recibo de pagamento</h3>
            <div id="reciboContent" class="receipt-modern"></div>
            <button class="btn-primary" id="btnPdf" style="width:100%; margin: 12px 0 8px;">üì• Baixar PDF</button>
            <button class="btn-secondary" id="fecharModal">Fechar</button>
        </div>
    </div>

    <!-- MODAL PARA ADICIONAR N√öMEROS -->
    <div id="participanteModal" class="modal-overlay">
        <div class="modal modal-add">
            <h3 id="modalTitle">‚ûï Adicionar n√∫meros</h3>
            <div class="input-group">
                <label><span>üéØ</span> A√ß√£o (m√™s do sorteio)</label>
                <select id="participanteAcaoSelect" required>
                    <option value="">Selecione uma a√ß√£o</option>
                </select>
                <div class="hint" id="acaoMesHint"></div>
            </div>
            <div class="input-group">
                <label><span>üë§</span> Nome completo</label>
                <input type="text" id="participanteNome" placeholder="Ex: Jo√£o da Silva">
            </div>
            <div class="input-group">
                <label><span>üî¢</span> N√∫meros</label>
                <textarea id="participanteNumeros" placeholder="Ex: 10, 15, 22, 37" rows="3"></textarea>
                <div class="hint">
                    <span>‚ÑπÔ∏è</span> Separe por v√≠rgula. Todos far√£o parte do mesmo grupo.
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-save" id="salvarParticipante">Salvar grupo</button>
                <button class="btn-cancel" id="cancelarParticipante">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA EDITAR A√á√ÉO -->
    <div id="editarAcaoModal" class="modal-overlay">
        <div class="modal">
            <h3>‚úèÔ∏è Editar A√ß√£o</h3>
            <input type="hidden" id="editarAcaoId">
            <div class="config-row">
                <label>Nome da A√ß√£o</label>
                <input type="text" id="editarAcaoNome">
            </div>
            <div class="config-row">
                <label>Pr√™mio</label>
                <input type="text" id="editarAcaoPremio">
            </div>
            <div class="config-row">
                <label>Data do sorteio</label>
                <input type="date" id="editarAcaoData">
            </div>
            <div class="config-row">
                <label>Valor da cota (R$)</label>
                <input type="number" id="editarAcaoValor" step="0.01" min="0.01">
            </div>
            <div class="checkbox-row">
                <input type="checkbox" id="editarAcaoDisponivel">
                <label for="editarAcaoDisponivel">Dispon√≠vel para venda</label>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 20px;">
                <button class="btn-primary" id="salvarEdicaoAcao">Salvar</button>
                <button class="btn-danger" id="excluirAcao">Excluir</button>
                <button class="btn-secondary" id="cancelarEdicaoAcao">Cancelar</button>
            </div>
        </div>
    </div>

    <footer>Recibo √∫nico por grupo ‚Ä¢ Vendas por m√™s da a√ß√£o</footer>
</div>

<script>
    (async function() {
        const { jsPDF } = window.jspdf;

        // Atualiza√ß√£o para v4: adicionado campo mesRef
        const db = new Dexie('RifaProDB');
        db.version(4).stores({
            participantes: 'id, nome, numero, pago, dataPagamento, groupId, acaoId, mesRef',
            config: 'chave',
            acoes: 'id, nome, premio, dataSorteio, valor, disponivel'
        }).upgrade(async tx => {
            // Migra√ß√£o: calcular mesRef para participantes existentes com base na a√ß√£o
            const participantes = await tx.table('participantes').toArray();
            const acoes = await tx.table('acoes').toArray();
            const acoesMap = new Map(acoes.map(a => [a.id, a]));
            for (let p of participantes) {
                let mesRef = null;
                const acao = acoesMap.get(p.acaoId);
                if (acao && acao.dataSorteio) {
                    const d = new Date(acao.dataSorteio);
                    mesRef = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                } else {
                    // fallback: m√™s atual
                    const hoje = new Date();
                    mesRef = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
                }
                await tx.table('participantes').update(p.id, { mesRef });
            }
        });

        let participantes = [];
        let acoes = [];
        let filtroMes = 'todos';
        let termoBusca = '';
        let abaAtiva = 'participantes';

        // Elementos DOM
        const totalNumerosSpan = document.getElementById('totalNumeros');
        const totalArrecadadoSpan = document.getElementById('totalArrecadado');
        const totalMesSpan = document.getElementById('totalMes');
        const monthLabel = document.getElementById('monthLabel');
        const searchInput = document.getElementById('searchInput');
        const monthSelect = document.getElementById('monthFilter');
        const participantListDiv = document.getElementById('participantList');
        const btnAdicionar = document.getElementById('btnAdicionar');
        const reciboModal = document.getElementById('reciboModal');
        const reciboContent = document.getElementById('reciboContent');
        const fecharModal = document.getElementById('fecharModal');
        const btnPdf = document.getElementById('btnPdf');
        const participanteModal = document.getElementById('participanteModal');
        const modalTitle = document.getElementById('modalTitle');
        const participanteNomeInput = document.getElementById('participanteNome');
        const participanteNumerosInput = document.getElementById('participanteNumeros');
        const participanteAcaoSelect = document.getElementById('participanteAcaoSelect');
        const acaoMesHint = document.getElementById('acaoMesHint');
        const salvarParticipanteBtn = document.getElementById('salvarParticipante');
        const cancelarParticipanteBtn = document.getElementById('cancelarParticipante');
        const tabParticipantes = document.getElementById('tabParticipantes');
        const tabRelatorio = document.getElementById('tabRelatorio');
        const relatorioContainer = document.getElementById('relatorioContainer');
        const relatorioAcoesContainer = document.getElementById('relatorioAcoesContainer');
        const tabs = document.querySelectorAll('.tab');
        const exportBackupBtn = document.getElementById('exportBackup');
        const importBackupBtn = document.getElementById('importBackup');
        const fileInput = document.getElementById('fileInput');
        const gearBtn = document.getElementById('gearBtn');
        const configModal = document.getElementById('configModal');
        const fecharConfigModal = document.getElementById('fecharConfigModal');
        const exportMensalPDF = document.getElementById('exportMensalPDF');
        const exportCompletoPDF = document.getElementById('exportCompletoPDF');
        const acoesListDiv = document.getElementById('acoesList');
        const novaAcaoNome = document.getElementById('novaAcaoNome');
        const novaAcaoPremio = document.getElementById('novaAcaoPremio');
        const novaAcaoData = document.getElementById('novaAcaoData');
        const novaAcaoValor = document.getElementById('novaAcaoValor');
        const novaAcaoDisponivel = document.getElementById('novaAcaoDisponivel');
        const btnAdicionarAcao = document.getElementById('btnAdicionarAcao');
        const editarAcaoModal = document.getElementById('editarAcaoModal');
        const editarAcaoId = document.getElementById('editarAcaoId');
        const editarAcaoNome = document.getElementById('editarAcaoNome');
        const editarAcaoPremio = document.getElementById('editarAcaoPremio');
        const editarAcaoData = document.getElementById('editarAcaoData');
        const editarAcaoValor = document.getElementById('editarAcaoValor');
        const editarAcaoDisponivel = document.getElementById('editarAcaoDisponivel');
        const salvarEdicaoAcao = document.getElementById('salvarEdicaoAcao');
        const excluirAcao = document.getElementById('excluirAcao');
        const cancelarEdicaoAcao = document.getElementById('cancelarEdicaoAcao');

        let reciboAtual = null;

        // --- MIGRA√á√ÉO DE DADOS DA VERS√ÉO ANTERIOR (j√° tratada pelo upgrade) ---
        async function migrarDadosAntigos() {
            // N√£o √© mais necess√°rio, pois o upgrade trata, mas mantemos para compatibilidade
            const configValor = await db.config.get('valorRifa');
            const configPremio = await db.config.get('premio');
            const configData = await db.config.get('dataSorteio');
            const configNomeAcao = await db.config.get('nomeAcao');
            
            const acoesExistentes = await db.acoes.count();
            
            if (acoesExistentes === 0 && (configValor || configPremio || configData)) {
                const nomeAcao = configNomeAcao ? configNomeAcao.valor : 'A√ß√£o Padr√£o';
                const premio = configPremio ? configPremio.valor : 'Smartphone';
                const dataSorteio = configData ? configData.valor : (() => {
                    const hoje = new Date();
                    hoje.setDate(hoje.getDate() + 30);
                    return hoje.toISOString().split('T')[0];
                })();
                const valor = configValor ? configValor.valor : 5.00;

                const novaAcaoId = Date.now().toString();
                await db.acoes.add({
                    id: novaAcaoId,
                    nome: nomeAcao,
                    premio: premio,
                    dataSorteio: dataSorteio,
                    valor: valor,
                    disponivel: true
                });

                const participantesAntigos = await db.participantes.toArray();
                for (let p of participantesAntigos) {
                    await db.participantes.update(p.id, { acaoId: novaAcaoId });
                }
                console.log('Migra√ß√£o conclu√≠da.');
            }
        }

        // --- CARREGAR A√á√ïES ---
        async function carregarAcoes() {
            acoes = await db.acoes.toArray();
            preencherSelectAcoes();
            renderizarListaAcoes();
            renderizarRelatorioAcoes();
        }

        function preencherSelectAcoes() {
            const select = participanteAcaoSelect;
            select.innerHTML = '<option value="">Selecione uma a√ß√£o</option>';
            acoes.filter(a => a.disponivel).forEach(a => {
                const option = document.createElement('option');
                option.value = a.id;
                option.textContent = `${a.nome} (R$ ${a.valor.toFixed(2)})`;
                select.appendChild(option);
            });
            // Atualizar hint do m√™s
            if (select.value) {
                const acao = acoes.find(a => a.id === select.value);
                if (acao) {
                    const d = new Date(acao.dataSorteio);
                    const mesAno = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    acaoMesHint.innerText = `üóìÔ∏è M√™s de refer√™ncia: ${mesAno}`;
                }
            } else {
                acaoMesHint.innerText = '';
            }
        }

        // Mostrar m√™s da a√ß√£o ao selecionar
        participanteAcaoSelect.addEventListener('change', (e) => {
            const acaoId = e.target.value;
            const acao = acoes.find(a => a.id === acaoId);
            if (acao) {
                const d = new Date(acao.dataSorteio);
                const mesAno = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                acaoMesHint.innerText = `üóìÔ∏è M√™s de refer√™ncia: ${mesAno}`;
            } else {
                acaoMesHint.innerText = '';
            }
        });

        function renderizarListaAcoes() {
            if (!acoesListDiv) return;
            if (acoes.length === 0) {
                acoesListDiv.innerHTML = '<div class="empty-message">Nenhuma a√ß√£o cadastrada.</div>';
                return;
            }
            let html = '';
            acoes.forEach(a => {
                const statusClass = a.disponivel ? 'disponivel' : '';
                const statusText = a.disponivel ? 'Dispon√≠vel' : 'Indispon√≠vel';
                html += `
                    <div class="acao-item">
                        <div class="acao-info">
                            <div class="acao-nome">${a.nome} <span class="acao-status ${statusClass}">${statusText}</span></div>
                            <div class="acao-detalhes">Pr√™mio: ${a.premio} | Sorteio: ${new Date(a.dataSorteio).toLocaleDateString('pt-BR')} | R$ ${a.valor.toFixed(2)}</div>
                        </div>
                        <div class="acao-actions">
                            <button class="editar-acao" data-id="${a.id}">‚úèÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            acoesListDiv.innerHTML = html;
            document.querySelectorAll('.editar-acao').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    abrirModalEdicao(id);
                });
            });
        }

        function abrirModalEdicao(id) {
            const acao = acoes.find(a => a.id === id);
            if (!acao) return;
            editarAcaoId.value = acao.id;
            editarAcaoNome.value = acao.nome;
            editarAcaoPremio.value = acao.premio;
            editarAcaoData.value = acao.dataSorteio;
            editarAcaoValor.value = acao.valor;
            editarAcaoDisponivel.checked = acao.disponivel;
            editarAcaoModal.style.display = 'flex';
        }

        // --- CARREGAR PARTICIPANTES ---
        async function carregarParticipantes() {
            participantes = await db.participantes.toArray();
            // Garantir que todos tenham groupId e reciboNum e mesRef
            let precisaAtualizar = false;
            for (let p of participantes) {
                if (!p.groupId) {
                    p.groupId = p.id;
                    await db.participantes.update(p.id, { groupId: p.id });
                    precisaAtualizar = true;
                }
                if (!p.reciboNum) {
                    const hash = p.groupId.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
                    p.reciboNum = (hash % 9000 + 1000);
                    await db.participantes.update(p.id, { reciboNum: p.reciboNum });
                    precisaAtualizar = true;
                }
                if (!p.mesRef) {
                    // Se n√£o tiver mesRef, tenta calcular da a√ß√£o
                    const acao = acoes.find(a => a.id === p.acaoId);
                    if (acao && acao.dataSorteio) {
                        const d = new Date(acao.dataSorteio);
                        p.mesRef = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                        await db.participantes.update(p.id, { mesRef: p.mesRef });
                        precisaAtualizar = true;
                    }
                }
            }
            if (precisaAtualizar) {
                participantes = await db.participantes.toArray();
            }
            aplicarFiltrosEAtualizar();
            renderizarRelatorioAcoes();
        }

        // --- FUN√á√ïES AUXILIARES ---
        function numeroDisponivel(numero, acaoId, ignorarId = null) {
            return !participantes.some(p => p.numero === numero && p.acaoId === acaoId && p.id !== ignorarId);
        }

        async function processarNumeros(texto, acaoId, ignorarId = null) {
            if (!texto.trim()) return [];
            const partes = texto.split(',').map(p => p.trim()).filter(p => p !== '');
            const numeros = [];
            const erros = [];

            for (let parte of partes) {
                const num = parseInt(parte);
                if (isNaN(num)) {
                    erros.push(`"${parte}" n√£o √© um n√∫mero`);
                    continue;
                }
                if (num <= 0) {
                    erros.push(`N√∫mero ${num} deve ser positivo`);
                    continue;
                }
                if (!numeroDisponivel(num, acaoId, ignorarId)) {
                    erros.push(`N√∫mero ${num} j√° est√° em uso nesta a√ß√£o`);
                    continue;
                }
                numeros.push(num);
            }

            if (erros.length > 0) {
                alert('Erros:\n' + erros.join('\n'));
                return null;
            }
            return numeros;
        }

        function gerarNumeroRecibo() {
            return Math.floor(1000 + Math.random() * 9000);
        }

        // Salvar participantes com mesRef baseado na data da a√ß√£o
        async function salvarMultiplosParticipantes(acaoId, nome, numerosTexto) {
            if (!acaoId) {
                alert('Selecione uma a√ß√£o.');
                return false;
            }
            if (!nome.trim()) {
                alert('Digite o nome');
                return false;
            }

            const numeros = await processarNumeros(numerosTexto, acaoId);
            if (!numeros) return false;

            const acao = acoes.find(a => a.id === acaoId);
            if (!acao) {
                alert('A√ß√£o n√£o encontrada.');
                return false;
            }
            // Calcular m√™s de refer√™ncia a partir da data do sorteio
            const dataSorteio = new Date(acao.dataSorteio);
            const mesRef = `${dataSorteio.getFullYear()}-${String(dataSorteio.getMonth()+1).padStart(2,'0')}`;

            const groupId = 'grupo_' + Date.now() + '_' + Math.random().toString(36).substring(2);
            const reciboNum = gerarNumeroRecibo();

            for (let num of numeros) {
                await db.participantes.add({
                    id: Date.now().toString() + Math.random().toString(36).substring(2) + num,
                    nome: nome.trim(),
                    numero: num,
                    pago: false,
                    dataPagamento: null,
                    groupId: groupId,
                    reciboNum: reciboNum,
                    acaoId: acaoId,
                    mesRef: mesRef
                });
            }
            return true;
        }

        async function marcarPagoGrupo(groupId) {
            const participantesGrupo = participantes.filter(p => p.groupId === groupId);
            for (let p of participantesGrupo) {
                if (!p.pago) {
                    await db.participantes.update(p.id, {
                        pago: true,
                        dataPagamento: new Date().toISOString()
                    });
                }
            }
            await carregarParticipantes();
            if (abaAtiva === 'relatorio') {
                renderizarRelatorio();
                renderizarRelatorioAcoes();
            }
        }

        async function excluirGrupo(groupId) {
            if (confirm('Remover todos os n√∫meros deste grupo?')) {
                const participantesGrupo = participantes.filter(p => p.groupId === groupId);
                for (let p of participantesGrupo) {
                    await db.participantes.delete(p.id);
                }
                await carregarParticipantes();
                if (abaAtiva === 'relatorio') {
                    renderizarRelatorio();
                    renderizarRelatorioAcoes();
                }
            }
        }

        // --- RECIBO (inalterado) ---
        function exibirReciboGrupo(groupId) {
            const grupo = participantes.filter(p => p.groupId === groupId);
            if (grupo.length === 0) return;
            if (!grupo.every(p => p.pago)) {
                alert('Apenas grupos totalmente pagos podem gerar recibo.');
                return;
            }
            reciboAtual = grupo;

            const acao = acoes.find(a => a.id === grupo[0].acaoId);
            if (!acao) {
                alert('A√ß√£o n√£o encontrada.');
                return;
            }

            const nome = grupo[0].nome;
            const numeros = grupo.map(p => p.numero).sort((a,b) => a-b);
            const dataPagamento = grupo[0].dataPagamento ? new Date(grupo[0].dataPagamento).toLocaleString('pt-BR') : '‚Äî';
            const dataSorteioFormatada = acao.dataSorteio ? new Date(acao.dataSorteio).toLocaleDateString('pt-BR') : '‚Äî';
            const valorTotal = grupo.length * acao.valor;
            const numerosStr = numeros.map(n => `#${n}`).join(', ');
            const reciboNum = grupo[0].reciboNum || 0;

            const html = `
                <div class="receipt-header">
                    <h4>RECIBO</h4>
                    <span class="receipt-badge">#${reciboNum.toString().padStart(4,'0')}</span>
                </div>
                <div class="receipt-grid">
                    <div class="receipt-item"><span class="label">A√ß√£o</span><div class="value">${acao.nome}</div></div>
                    <div class="receipt-item"><span class="label">Participante</span><div class="value">${nome}</div></div>
                    <div class="receipt-item"><span class="label">N√∫meros</span><div class="value">${numerosStr}</div></div>
                    <div class="receipt-item"><span class="label">Quantidade</span><div class="value">${grupo.length}</div></div>
                    <div class="receipt-item"><span class="label">Valor unit.</span><div class="value">R$ ${acao.valor.toFixed(2)}</div></div>
                    <div class="receipt-item"><span class="label">Pr√™mio</span><div class="value">${acao.premio}</div></div>
                    <div class="receipt-item"><span class="label">Sorteio</span><div class="value">${dataSorteioFormatada}</div></div>
                    <div class="receipt-item"><span class="label">Pagamento</span><div class="value">${dataPagamento}</div></div>
                </div>
                <div class="receipt-total">
                    <span>TOTAL PAGO</span>
                    <span>R$ ${valorTotal.toFixed(2)}</span>
                </div>
            `;
            reciboContent.innerHTML = html;
            reciboModal.style.display = 'flex';
        }

        function gerarPDFGrupo(grupo) {
            // ... (mesmo c√≥digo, inalterado)
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const contentWidth = pageWidth - 2 * margin;

            const acao = acoes.find(a => a.id === grupo[0].acaoId);
            if (!acao) return;

            const azulEscuro = '#1e3b5c';
            const azulClaro = '#e9eff9';
            const textoEscuro = '#1a2b3c';
            const textoMedio = '#5f748e';

            function hexToRgb(hex) {
                const r = parseInt(hex.slice(1,3), 16);
                const g = parseInt(hex.slice(3,5), 16);
                const b = parseInt(hex.slice(5,7), 16);
                return [r, g, b];
            }

            doc.setFillColor(...hexToRgb(azulEscuro));
            doc.rect(margin, 20, contentWidth, 18, 'F');
            doc.setTextColor(255,255,255);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RECIBO DE PAGAMENTO', pageWidth / 2, 32, { align: 'center' });

            const reciboNum = (grupo[0].reciboNum || 0).toString().padStart(4,'0');
            doc.setFontSize(10);
            doc.setTextColor(255,255,255);
            doc.text(`#${reciboNum}`, pageWidth - margin - 10, 32, { align: 'right' });

            doc.setTextColor(...hexToRgb(textoEscuro));
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');

            const yStart = 50;
            const lineHeight = 10;
            const colWidth = (contentWidth - 20) / 2;

            doc.setFont(undefined, 'bold');
            doc.text('A√ß√£o:', margin, yStart);
            doc.setFont(undefined, 'normal');
            doc.text(acao.nome, margin + 30, yStart, { maxWidth: contentWidth - 40 });

            doc.setFont(undefined, 'bold');
            doc.text('Participante:', margin, yStart + lineHeight);
            doc.setFont(undefined, 'normal');
            doc.text(grupo[0].nome, margin + 50, yStart + lineHeight);

            doc.setFont(undefined, 'bold');
            doc.text('N√∫meros:', margin, yStart + 2*lineHeight);
            doc.setFont(undefined, 'normal');
            const numerosStr = grupo.map(p => p.numero).sort((a,b) => a-b).join(', ');
            doc.text(numerosStr, margin + 40, yStart + 2*lineHeight, { maxWidth: contentWidth - 50 });

            doc.setFont(undefined, 'bold');
            doc.text('Quantidade:', margin, yStart + 3*lineHeight);
            doc.setFont(undefined, 'normal');
            doc.text(grupo.length.toString(), margin + 50, yStart + 3*lineHeight);

            doc.setFont(undefined, 'bold');
            doc.text('Valor unit.:', margin, yStart + 4*lineHeight);
            doc.setFont(undefined, 'normal');
            doc.text(`R$ ${acao.valor.toFixed(2)}`, margin + 50, yStart + 4*lineHeight);

            const x2 = margin + colWidth + 10;
            doc.setFont(undefined, 'bold');
            doc.text('Pr√™mio:', x2, yStart + 3*lineHeight);
            doc.setFont(undefined, 'normal');
            doc.text(acao.premio, x2 + 30, yStart + 3*lineHeight, { maxWidth: colWidth - 30 });

            doc.setFont(undefined, 'bold');
            doc.text('Sorteio:', x2, yStart + 4*lineHeight);
            doc.setFont(undefined, 'normal');
            const dataSorteioFormatada = acao.dataSorteio ? new Date(acao.dataSorteio).toLocaleDateString('pt-BR') : '‚Äî';
            doc.text(dataSorteioFormatada, x2 + 30, yStart + 4*lineHeight);

            doc.setFont(undefined, 'bold');
            doc.text('Pagamento:', x2, yStart + 5*lineHeight);
            doc.setFont(undefined, 'normal');
            const dataPagamento = grupo[0].dataPagamento ? new Date(grupo[0].dataPagamento).toLocaleString('pt-BR') : '‚Äî';
            doc.text(dataPagamento, x2 + 30, yStart + 5*lineHeight, { maxWidth: colWidth - 30 });

            doc.setDrawColor(...hexToRgb(azulEscuro));
            doc.setLineWidth(0.5);
            doc.line(margin, yStart + 6*lineHeight + 2, pageWidth - margin, yStart + 6*lineHeight + 2);

            const totalY = yStart + 7*lineHeight;
            const valorTotal = grupo.length * acao.valor;
            doc.setFillColor(...hexToRgb(azulClaro));
            doc.roundedRect(margin, totalY - 4, contentWidth, 20, 3, 3, 'F');
            doc.setTextColor(...hexToRgb(textoEscuro));
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL PAGO', margin + 10, totalY + 8);
            doc.text(`R$ ${valorTotal.toFixed(2)}`, pageWidth - margin - 30, totalY + 8, { align: 'right' });

            doc.setFontSize(8);
            doc.setTextColor(...hexToRgb(textoMedio));
            doc.text('Documento gerado por A√ß√£o Pro', pageWidth / 2, 280, { align: 'center' });

            doc.save(`recibo_${grupo[0].nome.replace(/\s/g,'_')}_${reciboNum}.pdf`);
        }

        // --- RELAT√ìRIO POR A√á√ÉO (inalterado) ---
        function renderizarRelatorioAcoes() {
            if (!relatorioAcoesContainer) return;
            if (acoes.length === 0) {
                relatorioAcoesContainer.innerHTML = '<div class="empty-message">Nenhuma a√ß√£o cadastrada.</div>';
                return;
            }

            let html = '';
            acoes.forEach(acao => {
                const participantesAcao = participantes.filter(p => p.acaoId === acao.id && p.pago);
                const totalArrecadado = participantesAcao.reduce((sum, p) => sum + acao.valor, 0);
                const totalNumeros = participantesAcao.length;
                const statusClass = acao.disponivel ? 'disponivel' : '';
                const statusText = acao.disponivel ? 'Dispon√≠vel' : 'Indispon√≠vel';

                html += `
                    <div class="acao-relatorio-card" data-acao-id="${acao.id}">
                        <div class="acao-relatorio-header">
                            <span class="acao-relatorio-nome">${acao.nome}</span>
                            <span class="acao-relatorio-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="acao-relatorio-detalhes">
                            <span>üéÅ ${acao.premio}</span>
                            <span>üìÖ ${new Date(acao.dataSorteio).toLocaleDateString('pt-BR')}</span>
                            <span class="acao-relatorio-total">üí∞ R$ ${totalArrecadado.toFixed(2)}</span>
                        </div>
                        <div class="acao-relatorio-participantes">
                            ${participantesAcao.length === 0 ? '<div class="empty-message" style="padding:10px;">Nenhum pagamento registrado.</div>' : ''}
                            ${participantesAcao.sort((a,b) => a.numero - b.numero).map(p => `
                                <div class="acao-participante-item">
                                    <span>#${p.numero} - ${p.nome}</span>
                                    <span>R$ ${acao.valor.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn-relatorio-pdf export-acao-pdf" data-acao-id="${acao.id}">
                            üì• Exportar PDF da A√ß√£o
                        </button>
                    </div>
                `;
            });
            relatorioAcoesContainer.innerHTML = html;

            document.querySelectorAll('.export-acao-pdf').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const acaoId = e.target.dataset.acaoId;
                    gerarPDFRelatorioAcao(acaoId);
                });
            });
        }

        function gerarPDFRelatorioAcao(acaoId) {
            // ... (c√≥digo existente, inalterado)
            const acao = acoes.find(a => a.id === acaoId);
            if (!acao) return;
            const participantesAcao = participantes.filter(p => p.acaoId === acaoId && p.pago);
            const totalArrecadado = participantesAcao.reduce((sum, p) => sum + acao.valor, 0);

            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const contentWidth = pageWidth - 2 * margin;

            const azulEscuro = '#1e3b5c';
            const azulClaro = '#e9eff9';
            const textoEscuro = '#1a2b3c';
            const textoMedio = '#5f748e';

            function hexToRgb(hex) {
                const r = parseInt(hex.slice(1,3), 16);
                const g = parseInt(hex.slice(3,5), 16);
                const b = parseInt(hex.slice(5,7), 16);
                return [r, g, b];
            }

            doc.setFillColor(...hexToRgb(azulEscuro));
            doc.rect(margin, 20, contentWidth, 18, 'F');
            doc.setTextColor(255,255,255);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RELAT√ìRIO DE A√á√ÉO', pageWidth / 2, 32, { align: 'center' });

            doc.setTextColor(...hexToRgb(textoEscuro));
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(acao.nome, margin, 50);

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Pr√™mio: ${acao.premio}`, margin, 60);
            doc.text(`Sorteio: ${new Date(acao.dataSorteio).toLocaleDateString('pt-BR')}`, margin, 70);
            doc.text(`Valor da cota: R$ ${acao.valor.toFixed(2)}`, margin, 80);
            doc.text(`Total arrecadado: R$ ${totalArrecadado.toFixed(2)}`, margin, 90);

            let y = 110;
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...hexToRgb(azulEscuro));
            doc.text('N¬∫', margin, y);
            doc.text('Participante', margin + 30, y);
            doc.text('Valor', pageWidth - margin - 30, y, { align: 'right' });

            doc.setDrawColor(...hexToRgb(azulEscuro));
            doc.setLineWidth(0.3);
            doc.line(margin, y + 2, pageWidth - margin, y + 2);
            y += 8;

            doc.setFont(undefined, 'normal');
            doc.setTextColor(...hexToRgb(textoEscuro));

            participantesAcao.sort((a,b) => a.numero - b.numero).forEach(p => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(p.numero.toString(), margin, y);
                doc.text(p.nome, margin + 30, y, { maxWidth: contentWidth - 90 });
                doc.text(`R$ ${acao.valor.toFixed(2)}`, pageWidth - margin - 30, y, { align: 'right' });
                y += 8;
            });

            y += 4;
            doc.setDrawColor(...hexToRgb(azulEscuro));
            doc.setLineWidth(0.5);
            doc.line(margin, y - 2, pageWidth - margin, y - 2);

            doc.setFont(undefined, 'bold');
            doc.setTextColor(...hexToRgb(textoEscuro));
            doc.text('TOTAL', margin, y + 4);
            doc.text(`R$ ${totalArrecadado.toFixed(2)}`, pageWidth - margin - 30, y + 4, { align: 'right' });

            doc.setFontSize(8);
            doc.setTextColor(...hexToRgb(textoMedio));
            doc.text('Relat√≥rio gerado por A√ß√£o Pro', pageWidth / 2, 280, { align: 'center' });

            doc.save(`relatorio_${acao.nome.replace(/\s/g,'_')}.pdf`);
        }

        // --- RENDERIZAR LISTA DE PARTICIPANTES (usando mesRef) ---
        function renderizarLista(lista) {
            if (lista.length === 0) {
                participantListDiv.innerHTML = '<div class="empty-message">Nenhum n√∫mero encontrado.</div>';
                return;
            }

            const grupoInfo = new Map();
            participantes.forEach(p => {
                if (!grupoInfo.has(p.groupId)) {
                    grupoInfo.set(p.groupId, { count: 0, anyPaid: false, allPaid: true });
                }
                const info = grupoInfo.get(p.groupId);
                info.count++;
                if (p.pago) info.anyPaid = true;
                else info.allPaid = false;
            });

            const sorted = [...lista].sort((a,b) => a.numero - b.numero);
            let html = '';

            sorted.forEach(p => {
                const info = grupoInfo.get(p.groupId);
                const statusClass = p.pago ? 'status-pago' : 'status-naopago';
                const statusText = p.pago ? 'PAGO' : 'N√ÉO PAGO';
                const dataStr = p.dataPagamento ? new Date(p.dataPagamento).toLocaleDateString('pt-BR') : '‚Äî';
                const multiple = info.count > 1 ? `<span class="group-badge">${info.count} n√∫m</span>` : '';
                const acao = acoes.find(a => a.id === p.acaoId);
                const acaoNome = acao ? acao.nome : 'A√ß√£o n√£o encontrada';
                // Mostrar m√™s de refer√™ncia
                const mesRefStr = p.mesRef ? new Date(p.mesRef+'-01').toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }) : '';

                html += `
                    <div class="participant-card" data-groupid="${p.groupId}">
                        <div class="part-row">
                            <span class="part-name">${p.nome} ${multiple}</span>
                            <span class="part-number">#${p.numero}</span>
                        </div>
                        <div class="part-details">
                            <span class="part-status ${statusClass}">${statusText}</span>
                            <span class="part-date">üìÖ ${dataStr}</span>
                            <span class="group-badge">${acaoNome}</span>
                            <span class="part-date">üóìÔ∏è ${mesRefStr}</span>
                        </div>
                        <div class="part-actions">
                            ${!info.allPaid ? `<button class="btn-action pagar" data-groupid="${p.groupId}">üíµ Pagar grupo</button>` : ''}
                            <button class="btn-action recibo" data-groupid="${p.groupId}" ${info.allPaid ? '' : 'disabled'}>üßæ Recibo</button>
                            <button class="btn-action excluir" data-groupid="${p.groupId}">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });

            participantListDiv.innerHTML = html;

            document.querySelectorAll('.btn-action.pagar').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    marcarPagoGrupo(btn.dataset.groupid);
                });
            });
            document.querySelectorAll('.btn-action.recibo').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    exibirReciboGrupo(btn.dataset.groupid);
                });
            });
            document.querySelectorAll('.btn-action.excluir').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    excluirGrupo(btn.dataset.groupid);
                });
            });
        }

        // --- ATUALIZAR RESUMO (usando mesRef) ---
        function atualizarResumo() {
            const totalNumeros = participantes.length;
            let arrecadado = 0;
            participantes.forEach(p => {
                if (p.pago) {
                    const acao = acoes.find(a => a.id === p.acaoId);
                    if (acao) arrecadado += acao.valor;
                }
            });
            totalNumerosSpan.innerText = totalNumeros;
            totalArrecadadoSpan.innerText = `R$ ${arrecadado.toFixed(2)}`;

            // Calcular total do m√™s atual com base em mesRef
            const hoje = new Date();
            const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
            let totalMes = 0;
            participantes.forEach(p => {
                if (p.pago && p.mesRef === mesAtual) {
                    const acao = acoes.find(a => a.id === p.acaoId);
                    if (acao) totalMes += acao.valor;
                }
            });
            totalMesSpan.innerText = `R$ ${totalMes.toFixed(2)}`;
            monthLabel.innerText = 'm√™s atual';
        }

        function preencherSelectMeses() {
            const mesesSet = new Set();
            participantes.forEach(p => {
                if (p.pago && p.mesRef) {
                    mesesSet.add(p.mesRef);
                }
            });
            const mesesArray = Array.from(mesesSet).sort().reverse();
            let options = '<option value="todos">Todos os meses</option>';
            mesesArray.forEach(key => {
                const [ano, mes] = key.split('-');
                const nomeMes = new Date(ano, mes-1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                options += `<option value="${key}">${nomeMes}</option>`;
            });
            monthSelect.innerHTML = options;
            if (filtroMes !== 'todos' && mesesArray.includes(filtroMes)) {
                monthSelect.value = filtroMes;
            } else {
                monthSelect.value = 'todos';
                filtroMes = 'todos';
            }
        }

        function renderizarRelatorio() {
            const mesesMap = new Map();
            participantes.forEach(p => {
                if (p.pago && p.mesRef) {
                    const chave = p.mesRef;
                    if (!mesesMap.has(chave)) {
                        const [ano, mes] = chave.split('-');
                        mesesMap.set(chave, {
                            ano: parseInt(ano),
                            mes: parseInt(mes),
                            participantes: [],
                            total: 0
                        });
                    }
                    mesesMap.get(chave).participantes.push(p);
                    const acao = acoes.find(a => a.id === p.acaoId);
                    if (acao) mesesMap.get(chave).total += acao.valor;
                }
            });

            if (mesesMap.size === 0) {
                relatorioContainer.innerHTML = '<div class="empty-message">Nenhum pagamento registrado.</div>';
                return;
            }

            const mesesOrdenados = Array.from(mesesMap.entries()).sort((a,b) => b[0].localeCompare(a[0]));

            let html = '';
            for (let [chave, dados] of mesesOrdenados) {
                const nomeMes = new Date(dados.ano, dados.mes-1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                html += `
                    <div class="month-block">
                        <div class="month-title">${nomeMes}</div>
                        <div class="month-total">R$ ${dados.total.toFixed(2)}</div>
                        <ul class="month-participants">
                `;
                dados.participantes.sort((a,b) => a.numero - b.numero).forEach(p => {
                    const acao = acoes.find(a => a.id === p.acaoId);
                    const valor = acao ? acao.valor : 0;
                    html += `<li><span>#${p.numero} - ${p.nome} (${acao ? acao.nome : '?'})</span> <span>R$ ${valor.toFixed(2)}</span></li>`;
                });
                html += `</ul></div>`;
            }
            relatorioContainer.innerHTML = html;
        }

        function aplicarFiltrosEAtualizar() {
            if (abaAtiva === 'participantes') {
                let listaFiltrada = participantes;
                if (termoBusca.trim() !== '') {
                    const termo = termoBusca.toLowerCase();
                    listaFiltrada = listaFiltrada.filter(p => p.nome.toLowerCase().includes(termo));
                }
                if (filtroMes !== 'todos') {
                    listaFiltrada = listaFiltrada.filter(p => p.pago && p.mesRef === filtroMes);
                }
                renderizarLista(listaFiltrada);
            }
            atualizarResumo();
            preencherSelectMeses();
        }

        // --- BACKUP (inalterado) ---
        async function exportarBackup() {
            const configs = await db.config.toArray();
            const participantes = await db.participantes.toArray();
            const acoes = await db.acoes.toArray();
            const backup = { data: new Date().toISOString(), configs, participantes, acoes };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `acao_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importarBackup() {
            fileInput.click();
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const backup = JSON.parse(ev.target.result);
                    if (!backup.acoes || !backup.participantes) throw new Error('Arquivo inv√°lido');
                    if (confirm('Isso substituir√° todos os dados atuais. Deseja continuar?')) {
                        await db.config.clear();
                        await db.participantes.clear();
                        await db.acoes.clear();
                        await db.config.bulkPut(backup.configs || []);
                        await db.participantes.bulkPut(backup.participantes);
                        await db.acoes.bulkPut(backup.acoes);
                        await carregarAcoes();
                        await carregarParticipantes();
                        alert('Backup restaurado!');
                    }
                } catch (err) {
                    alert('Erro ao ler backup: ' + err.message);
                } finally {
                    fileInput.value = '';
                }
            };
            reader.readAsText(file);
        });

        // --- EVENTOS ---
        gearBtn.addEventListener('click', () => {
            configModal.style.display = 'flex';
            renderizarListaAcoes();
        });
        fecharConfigModal.addEventListener('click', () => {
            configModal.style.display = 'none';
        });
        window.addEventListener('click', (e) => {
            if (e.target === configModal) configModal.style.display = 'none';
            if (e.target === reciboModal) reciboModal.style.display = 'none';
            if (e.target === participanteModal) participanteModal.style.display = 'none';
            if (e.target === editarAcaoModal) editarAcaoModal.style.display = 'none';
        });

        fecharModal.addEventListener('click', () => reciboModal.style.display = 'none');
        btnPdf.addEventListener('click', () => {
            if (reciboAtual) gerarPDFGrupo(reciboAtual);
        });

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                abaAtiva = tab.dataset.tab;
                if (abaAtiva === 'participantes') {
                    tabParticipantes.style.display = 'block';
                    tabRelatorio.style.display = 'none';
                    aplicarFiltrosEAtualizar();
                } else {
                    tabParticipantes.style.display = 'none';
                    tabRelatorio.style.display = 'block';
                    renderizarRelatorio();
                    renderizarRelatorioAcoes();
                }
            });
        });

        btnAdicionar.addEventListener('click', () => {
            if (acoes.filter(a => a.disponivel).length === 0) {
                alert('Cadastre pelo menos uma a√ß√£o dispon√≠vel antes de adicionar n√∫meros.');
                return;
            }
            modalTitle.innerText = '‚ûï Adicionar n√∫meros';
            participanteNomeInput.value = '';
            participanteNumerosInput.value = '';
            participanteAcaoSelect.value = '';
            acaoMesHint.innerText = '';
            participanteModal.style.display = 'flex';
        });

        salvarParticipanteBtn.addEventListener('click', async () => {
            const acaoId = participanteAcaoSelect.value;
            const nome = participanteNomeInput.value.trim();
            const numerosTexto = participanteNumerosInput.value.trim();
            if (await salvarMultiplosParticipantes(acaoId, nome, numerosTexto)) {
                participanteModal.style.display = 'none';
                await carregarParticipantes();
                if (abaAtiva === 'relatorio') {
                    renderizarRelatorio();
                    renderizarRelatorioAcoes();
                }
            }
        });

        cancelarParticipanteBtn.addEventListener('click', () => {
            participanteModal.style.display = 'none';
        });

        btnAdicionarAcao.addEventListener('click', async () => {
            const nome = novaAcaoNome.value.trim();
            const premio = novaAcaoPremio.value.trim();
            const data = novaAcaoData.value;
            const valor = parseFloat(novaAcaoValor.value);
            const disponivel = novaAcaoDisponivel.checked;

            if (!nome || !premio || !data || isNaN(valor) || valor <= 0) {
                alert('Preencha todos os campos corretamente.');
                return;
            }

            const novaAcao = {
                id: Date.now().toString(),
                nome,
                premio,
                dataSorteio: data,
                valor,
                disponivel
            };
            await db.acoes.add(novaAcao);
            await carregarAcoes();
            novaAcaoNome.value = '';
            novaAcaoPremio.value = '';
            novaAcaoData.value = '';
            novaAcaoValor.value = '5.00';
            novaAcaoDisponivel.checked = true;
        });

        salvarEdicaoAcao.addEventListener('click', async () => {
            const id = editarAcaoId.value;
            const nome = editarAcaoNome.value.trim();
            const premio = editarAcaoPremio.value.trim();
            const data = editarAcaoData.value;
            const valor = parseFloat(editarAcaoValor.value);
            const disponivel = editarAcaoDisponivel.checked;

            if (!nome || !premio || !data || isNaN(valor) || valor <= 0) {
                alert('Preencha todos os campos corretamente.');
                return;
            }

            await db.acoes.update(id, { nome, premio, dataSorteio: data, valor, disponivel });
            await carregarAcoes();
            editarAcaoModal.style.display = 'none';
        });

        excluirAcao.addEventListener('click', async () => {
            const id = editarAcaoId.value;
            const participantesVinculados = participantes.filter(p => p.acaoId === id);
            if (participantesVinculados.length > 0) {
                if (!confirm(`Esta a√ß√£o possui ${participantesVinculados.length} n√∫meros vinculados. Deseja realmente excluir? Os n√∫meros ser√£o perdidos.`)) {
                    return;
                }
                for (let p of participantesVinculados) {
                    await db.participantes.delete(p.id);
                }
            }
            await db.acoes.delete(id);
            await carregarAcoes();
            await carregarParticipantes();
            editarAcaoModal.style.display = 'none';
        });

        cancelarEdicaoAcao.addEventListener('click', () => {
            editarAcaoModal.style.display = 'none';
        });

        searchInput.addEventListener('input', (e) => {
            termoBusca = e.target.value;
            aplicarFiltrosEAtualizar();
        });

        monthSelect.addEventListener('change', (e) => {
            filtroMes = e.target.value;
            aplicarFiltrosEAtualizar();
        });

        exportBackupBtn.addEventListener('click', exportarBackup);
        importBackupBtn.addEventListener('click', importarBackup);

        exportMensalPDF.addEventListener('click', () => {
            alert('Funcionalidade de exportar PDF mensal ser√° implementada em breve.');
        });
        exportCompletoPDF.addEventListener('click', () => {
            alert('Funcionalidade de exportar PDF completo ser√° implementada em breve.');
        });

        // Inicializa√ß√£o
        await migrarDadosAntigos();
        await carregarAcoes();
        await carregarParticipantes();

        const hoje = new Date().toISOString().split('T')[0];
        novaAcaoData.min = hoje;
        editarAcaoData.min = hoje;
    })();
</script>
</body>
</html>
