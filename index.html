<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Rifa Pro ¬∑ Grupo ¬∑ Recibo √∫nico</title>
    <!-- Dexie (IndexedDB) -->
    <script src="https://unpkg.com/dexie@3.2.3/dist/dexie.js"></script>
    <!-- jsPDF para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* (mesmo estilo anterior, mantido por brevidade) */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f7fc;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 10px;
        }

        .app {
            max-width: 480px;
            width: 100%;
            background: #ffffff;
            border-radius: 36px 36px 24px 24px;
            box-shadow: 0 20px 40px rgba(0,20,50,0.1);
            overflow: hidden;
            padding: 20px 16px 30px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #0b1f34;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            background: #0066ff;
            color: white;
            font-size: 0.8rem;
            padding: 5px 14px;
            border-radius: 40px;
            font-weight: 500;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: #f0f4fa;
            padding: 6px;
            border-radius: 60px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            font-weight: 600;
            color: #4b5e77;
            border-radius: 50px;
            transition: 0.2s;
            cursor: pointer;
        }

        .tab.active {
            background: #ffffff;
            color: #0066ff;
            box-shadow: 0 4px 12px rgba(0,102,255,0.15);
        }

        .card {
            background: #ffffff;
            border-radius: 26px;
            padding: 20px 16px;
            margin-bottom: 20px;
            border: 1px solid #e9eef4;
            box-shadow: 0 6px 16px rgba(0,0,0,0.02);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #152b44;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .config-row label {
            font-weight: 500;
            color: #2a405c;
            min-width: 70px;
        }

        .config-row input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 40px;
            border: 1.5px solid #d0dae8;
            font-size: 1rem;
            background: #f9fcff;
        }

        .config-row input:focus {
            outline: none;
            border-color: #0066ff;
        }

        .btn-small {
            background: #0066ff;
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 40px;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 6px 12px -4px #0066ff80;
        }

        .stats {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat {
            flex: 1;
            background: #f8fbfe;
            border-radius: 24px;
            padding: 14px 6px;
            text-align: center;
            border: 1px solid #e2e9f2;
        }

        .stat .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #5e728e;
        }

        .stat .value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #0c1f33;
            line-height: 1.2;
        }

        .stat.destacado {
            background: #e1ebff;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search {
            flex: 2;
            min-width: 180px;
            background: #f2f6fc;
            border-radius: 50px;
            padding: 4px 4px 4px 20px;
            display: flex;
            align-items: center;
            border: 1px solid #dae2ed;
        }

        .search span {
            font-size: 1.2rem;
            opacity: 0.5;
            margin-right: 6px;
        }

        .search input {
            border: none;
            background: transparent;
            padding: 14px 0;
            width: 100%;
            font-size: 1rem;
        }

        .search input:focus {
            outline: none;
        }

        .filter-month {
            flex: 1;
            background: #f2f6fc;
            border-radius: 50px;
            padding: 0 6px 0 18px;
            display: flex;
            align-items: center;
            border: 1px solid #dae2ed;
        }

        .filter-month select {
            background: transparent;
            border: none;
            padding: 14px 0;
            font-size: 1rem;
            width: 100%;
            font-weight: 500;
            color: #152b44;
        }

        .filter-month select:focus {
            outline: none;
        }

        .btn-add {
            background: #0066ff;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            padding: 18px 24px;
            border-radius: 60px;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 16px 30px -8px #0066ff80;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .participant-card {
            background: #ffffff;
            border-radius: 28px;
            padding: 18px 16px;
            border: 1px solid #e9ecf1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }

        .part-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .part-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: #0e263b;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .group-badge {
            background: #e0e8ff;
            color: #0066ff;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 40px;
        }

        .part-number {
            background: #132b45;
            color: white;
            padding: 6px 18px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
        }

        .part-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 8px;
            margin-bottom: 16px;
            color: #3f5670;
            font-weight: 500;
            align-items: center;
        }

        .part-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0f4fa;
            padding: 5px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
        }

        .status-pago {
            background: #c8f0d3;
            color: #0e6732;
            font-weight: 600;
        }

        .status-naopago {
            background: #ffe8e0;
            color: #b13e2d;
        }

        .part-date {
            font-size: 0.85rem;
            color: #5e718b;
        }

        .part-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            border-top: 1px dashed #dbe1e9;
            padding-top: 16px;
            flex-wrap: wrap;
        }

        .btn-action {
            background: transparent;
            border: 1.5px solid #cad2de;
            padding: 12px 16px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #1e3148;
            cursor: pointer;
            flex: 1;
            min-width: 70px;
        }

        .btn-action.pagar {
            background: #0066ff;
            border-color: #0066ff;
            color: white;
        }

        .btn-action:disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .relatorio-mensal {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .month-block {
            background: #f9fcff;
            border-radius: 28px;
            padding: 16px;
            border: 1px solid #dee7f2;
        }

        .month-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #0e263b;
            margin-bottom: 8px;
        }

        .month-total {
            font-size: 2rem;
            font-weight: 800;
            color: #0066ff;
            margin-bottom: 12px;
        }

        .month-participants {
            list-style: none;
        }

        .month-participants li {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e8f2;
        }

        .month-participants li:last-child {
            border-bottom: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,20,40,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .modal {
            background: white;
            border-radius: 40px;
            max-width: 440px;
            width: 100%;
            padding: 30px 24px;
            box-shadow: 0 30px 50px rgba(0,0,0,0.3);
        }

        .modal h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #0b1e33;
            margin-bottom: 20px;
        }

        .modal input, .modal textarea {
            width: 100%;
            padding: 18px;
            border-radius: 30px;
            border: 1.5px solid #d0dae8;
            font-size: 1rem;
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-actions button {
            flex: 1;
            padding: 16px;
            border-radius: 60px;
            font-weight: 700;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: #0066ff;
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #1e3148;
        }

        .btn-fechar {
            background: #1a314a;
            color: white;
            border: none;
            padding: 18px;
            border-radius: 60px;
            width: 100%;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 12px;
        }

        .empty-message {
            text-align: center;
            padding: 40px 0;
            color: #7d8fa4;
            font-weight: 500;
        }

        footer {
            font-size: 0.75rem;
            color: #a0b2c7;
            text-align: center;
            margin-top: 24px;
        }

        .mt-2 { margin-top: 8px; }
        .text-small { font-size: 0.85rem; color: #5e728e; }
    </style>
</head>
<body>
<div class="app">
    <h1>üéüÔ∏è Rifa<span class="badge">GRUPO</span></h1>

    <div class="tabs">
        <div class="tab active" data-tab="participantes">Participantes</div>
        <div class="tab" data-tab="relatorio">Relat√≥rio Mensal</div>
    </div>

    <div id="tabParticipantes" style="display: block;">
        <div class="card">
            <div class="card-header">
                <h2>‚öôÔ∏è Configura√ß√µes</h2>
            </div>
            <div class="config-row">
                <label>Pr√™mio</label>
                <input type="text" id="premioInput" placeholder="Ex: Smartphone" value="Smartphone">
            </div>
            <div class="config-row">
                <label>Data sorteio</label>
                <input type="date" id="dataSorteioInput">
            </div>
            <div class="config-row">
                <label>Valor R$</label>
                <input type="number" id="valorRifaInput" step="0.01" min="0.01" value="5.00" style="flex:0.8;">
                <button class="btn-small" id="btnSalvarConfig">Salvar</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="label">n√∫meros</div>
                <div class="value" id="totalNumeros">0</div>
            </div>
            <div class="stat">
                <div class="label">arrecadado</div>
                <div class="value" id="totalArrecadado">R$0</div>
            </div>
            <div class="stat destacado">
                <div class="label" id="monthLabel">m√™s atual</div>
                <div class="value" id="totalMes">R$0</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="search">
                <span>üîç</span>
                <input type="text" id="searchInput" placeholder="Buscar nome...">
            </div>
            <div class="filter-month">
                <select id="monthFilter">
                    <option value="todos">Todos os meses</option>
                </select>
            </div>
        </div>

        <button class="btn-add" id="btnAdicionar">‚ûï Adicionar n√∫meros</button>

        <div class="participant-list" id="participantList">
            <div class="empty-message">Nenhum n√∫mero cadastrado.</div>
        </div>
    </div>

    <div id="tabRelatorio" style="display: none;">
        <div class="card">
            <h2>üìÜ Relat√≥rio por m√™s</h2>
            <div id="relatorioContainer" class="relatorio-mensal"></div>
        </div>
    </div>

    <div id="reciboModal" class="modal-overlay">
        <div class="modal">
            <h3>üßæ Recibo de pagamento</h3>
            <div id="reciboContent" style="background:#f4f8ff; border-radius:28px; padding:22px; margin:20px 0;"></div>
            <button class="btn-fechar" id="btnPdf">üì• Baixar PDF</button>
            <button class="btn-fechar" id="fecharModal" style="background:#5e728e;">Fechar</button>
        </div>
    </div>

    <div id="participanteModal" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">‚ûï Adicionar n√∫meros</h3>
            <input type="text" id="participanteNome" placeholder="Nome completo">
            <textarea id="participanteNumeros" placeholder="N√∫meros (separados por v√≠rgula, ex: 10,15,22)" rows="3"></textarea>
            <p class="text-small">Todos os n√∫meros far√£o parte do mesmo grupo e ter√£o um recibo √∫nico.</p>
            <div class="modal-actions">
                <button class="btn-primary" id="salvarParticipante">Salvar</button>
                <button class="btn-secondary" id="cancelarParticipante">Cancelar</button>
            </div>
        </div>
    </div>

    <footer>Recibo √∫nico por grupo ‚Ä¢ Dados salvos</footer>
</div>

<script>
    (async function() {
        const { jsPDF } = window.jspdf;

        // --- BANCO DE DADOS (vers√£o 2 com groupId) ---
        const db = new Dexie('RifaProDB');
        db.version(2).stores({
            participantes: 'id, nome, numero, pago, dataPagamento, groupId',
            config: 'chave'
        });

        let participantes = [];
        let valorRifa = 5.00;
        let premio = 'Smartphone';
        let dataSorteio = '';
        let filtroMes = 'todos';
        let termoBusca = '';
        let abaAtiva = 'participantes';

        // Elementos DOM
        const premioInput = document.getElementById('premioInput');
        const dataSorteioInput = document.getElementById('dataSorteioInput');
        const valorInput = document.getElementById('valorRifaInput');
        const btnSalvarConfig = document.getElementById('btnSalvarConfig');
        const totalNumerosSpan = document.getElementById('totalNumeros');
        const totalArrecadadoSpan = document.getElementById('totalArrecadado');
        const totalMesSpan = document.getElementById('totalMes');
        const monthLabel = document.getElementById('monthLabel');
        const searchInput = document.getElementById('searchInput');
        const monthSelect = document.getElementById('monthFilter');
        const participantListDiv = document.getElementById('participantList');
        const btnAdicionar = document.getElementById('btnAdicionar');
        const reciboModal = document.getElementById('reciboModal');
        const reciboContent = document.getElementById('reciboContent');
        const fecharModal = document.getElementById('fecharModal');
        const btnPdf = document.getElementById('btnPdf');
        const participanteModal = document.getElementById('participanteModal');
        const modalTitle = document.getElementById('modalTitle');
        const participanteNomeInput = document.getElementById('participanteNome');
        const participanteNumerosInput = document.getElementById('participanteNumeros');
        const salvarParticipanteBtn = document.getElementById('salvarParticipante');
        const cancelarParticipanteBtn = document.getElementById('cancelarParticipante');
        const tabParticipantes = document.getElementById('tabParticipantes');
        const tabRelatorio = document.getElementById('tabRelatorio');
        const relatorioContainer = document.getElementById('relatorioContainer');
        const tabs = document.querySelectorAll('.tab');

        let reciboAtual = null; // guarda o grupo para PDF

        // --- CARREGAR CONFIGURA√á√ïES ---
        async function carregarConfig() {
            const configValor = await db.config.get('valorRifa');
            if (configValor) valorRifa = configValor.valor;
            else await db.config.put({ chave: 'valorRifa', valor: valorRifa });

            const configPremio = await db.config.get('premio');
            if (configPremio) premio = configPremio.valor;
            else await db.config.put({ chave: 'premio', valor: premio });

            const configData = await db.config.get('dataSorteio');
            if (configData) dataSorteio = configData.valor;
            else {
                const hoje = new Date();
                hoje.setDate(hoje.getDate() + 30);
                dataSorteio = hoje.toISOString().split('T')[0];
                await db.config.put({ chave: 'dataSorteio', valor: dataSorteio });
            }

            premioInput.value = premio;
            dataSorteioInput.value = dataSorteio;
            valorInput.value = valorRifa.toFixed(2);
        }

        // --- CARREGAR PARTICIPANTES e garantir groupId para registros antigos ---
        async function carregarParticipantes() {
            let lista = await db.participantes.toArray();
            // Para registros sem groupId, definir groupId = id (grupo individual)
            let precisaAtualizar = false;
            for (let p of lista) {
                if (!p.groupId) {
                    p.groupId = p.id; // trata como grupo individual
                    await db.participantes.update(p.id, { groupId: p.id });
                    precisaAtualizar = true;
                }
            }
            if (precisaAtualizar) {
                lista = await db.participantes.toArray();
            }
            participantes = lista;
            aplicarFiltrosEAtualizar();
        }

        // --- GERAR N√öMERO √öNICO (caso n√£o especificado) ---
        async function gerarNumeroUnico() {
            const numerosExistentes = new Set(participantes.map(p => p.numero));
            for (let tentativa = 0; tentativa < 1000; tentativa++) {
                const num = Math.floor(Math.random() * 999) + 1;
                if (!numerosExistentes.has(num)) return num;
            }
            for (let i = 1000; i <= 9999; i++) {
                if (!numerosExistentes.has(i)) return i;
            }
            return Date.now() % 10000;
        }

        function numeroDisponivel(numero, ignorarId = null) {
            return !participantes.some(p => p.numero === numero && p.id !== ignorarId);
        }

        // --- PROCESSAR N√öMEROS (valida√ß√£o) ---
        async function processarNumeros(texto, ignorarId = null) {
            if (!texto.trim()) return [];
            const partes = texto.split(',').map(p => p.trim()).filter(p => p !== '');
            const numeros = [];
            const erros = [];

            for (let parte of partes) {
                const num = parseInt(parte);
                if (isNaN(num)) {
                    erros.push(`"${parte}" n√£o √© um n√∫mero`);
                    continue;
                }
                if (num <= 0) {
                    erros.push(`N√∫mero ${num} deve ser positivo`);
                    continue;
                }
                if (!numeroDisponivel(num, ignorarId)) {
                    erros.push(`N√∫mero ${num} j√° est√° em uso`);
                    continue;
                }
                numeros.push(num);
            }

            if (erros.length > 0) {
                alert('Erros:\n' + erros.join('\n'));
                return null;
            }
            return numeros;
        }

        // --- SALVAR M√öLTIPLOS N√öMEROS (MESMO GRUPO) ---
        async function salvarMultiplosParticipantes(nome, numerosTexto) {
            if (!nome.trim()) {
                alert('Digite o nome');
                return false;
            }

            const numeros = await processarNumeros(numerosTexto);
            if (!numeros) return false;

            const groupId = 'grupo_' + Date.now() + '_' + Math.random().toString(36).substring(2);

            for (let num of numeros) {
                await db.participantes.add({
                    id: Date.now().toString() + Math.random().toString(36).substring(2) + num,
                    nome: nome.trim(),
                    numero: num,
                    pago: false,
                    dataPagamento: null,
                    groupId: groupId
                });
            }
            return true;
        }

        // --- PAGAR GRUPO INTEIRO ---
        async function marcarPagoGrupo(groupId) {
            const participantesGrupo = participantes.filter(p => p.groupId === groupId);
            for (let p of participantesGrupo) {
                if (!p.pago) {
                    await db.participantes.update(p.id, {
                        pago: true,
                        dataPagamento: new Date().toISOString()
                    });
                }
            }
            await carregarParticipantes();
            if (abaAtiva === 'relatorio') renderizarRelatorio();
        }

        // --- EXCLUIR GRUPO INTEIRO ---
        async function excluirGrupo(groupId) {
            if (confirm('Remover todos os n√∫meros deste grupo?')) {
                const participantesGrupo = participantes.filter(p => p.groupId === groupId);
                for (let p of participantesGrupo) {
                    await db.participantes.delete(p.id);
                }
                await carregarParticipantes();
                if (abaAtiva === 'relatorio') renderizarRelatorio();
            }
        }

        // --- EXIBIR RECIBO DO GRUPO ---
        function exibirReciboGrupo(groupId) {
            const grupo = participantes.filter(p => p.groupId === groupId);
            if (grupo.length === 0) return;
            // Verifica se todos est√£o pagos
            if (!grupo.every(p => p.pago)) {
                alert('Apenas grupos totalmente pagos podem gerar recibo.');
                return;
            }
            reciboAtual = grupo; // armazena o array para PDF

            const nomes = grupo[0].nome; // mesmo nome para todos
            const numeros = grupo.map(p => p.numero).sort((a,b) => a-b);
            const dataPagamento = grupo[0].dataPagamento ? new Date(grupo[0].dataPagamento).toLocaleString('pt-BR') : '‚Äî';
            const dataSorteioFormatada = dataSorteio ? new Date(dataSorteio).toLocaleDateString('pt-BR') : '‚Äî';
            const valorTotal = grupo.length * valorRifa;

            let numerosHtml = numeros.map(n => `#${n}`).join(', ');

            reciboContent.innerHTML = `
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #b1c6df;"><strong>Participante</strong> <span>${nomes}</span></div>
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #b1c6df;"><strong>N√∫meros</strong> <span>${numerosHtml}</span></div>
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #b1c6df;"><strong>Quantidade</strong> <span>${grupo.length}</span></div>
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #b1c6df;"><strong>Valor unit√°rio</strong> <span>R$ ${valorRifa.toFixed(2)}</span></div>
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #b1c6df;"><strong>Valor total</strong> <span>R$ ${valorTotal.toFixed(2)}</span></div>
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #b1c6df;"><strong>Pr√™mio</strong> <span>${premio}</span></div>
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #b1c6df;"><strong>Sorteio</strong> <span>${dataSorteioFormatada}</span></div>
                <div style="display:flex; justify-content:space-between; padding:8px 0;"><strong>Data pgto.</strong> <span>${dataPagamento}</span></div>
            `;
            reciboModal.style.display = 'flex';
        }

        // --- GERAR PDF DO GRUPO ---
        function gerarPDFGrupo(grupo) {
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text('Recibo de Pagamento - Rifa', 20, 20);
            doc.setFontSize(12);
            const nome = grupo[0].nome;
            const numeros = grupo.map(p => p.numero).sort((a,b) => a-b).join(', ');
            const valorTotal = grupo.length * valorRifa;
            doc.text(`Participante: ${nome}`, 20, 40);
            doc.text(`N√∫meros: ${numeros}`, 20, 50);
            doc.text(`Quantidade: ${grupo.length}`, 20, 60);
            doc.text(`Valor unit√°rio: R$ ${valorRifa.toFixed(2)}`, 20, 70);
            doc.text(`Valor total: R$ ${valorTotal.toFixed(2)}`, 20, 80);
            doc.text(`Pr√™mio: ${premio}`, 20, 90);
            doc.text(`Data do sorteio: ${dataSorteio ? new Date(dataSorteio).toLocaleDateString('pt-BR') : '‚Äî'}`, 20, 100);
            doc.text(`Data do pagamento: ${grupo[0].dataPagamento ? new Date(grupo[0].dataPagamento).toLocaleString('pt-BR') : '‚Äî'}`, 20, 110);
            doc.save(`recibo_${nome}_${grupo.length}nums.pdf`);
        }

        // --- RENDERIZAR LISTA (com informa√ß√µes de grupo) ---
        function renderizarLista(lista) {
            if (lista.length === 0) {
                participantListDiv.innerHTML = '<div class="empty-message">Nenhum n√∫mero encontrado.</div>';
                return;
            }

            // Mapa para saber quantos n√∫meros por grupo e status
            const grupoInfo = new Map();
            participantes.forEach(p => {
                if (!grupoInfo.has(p.groupId)) {
                    grupoInfo.set(p.groupId, { count: 0, anyPaid: false, allPaid: true });
                }
                const info = grupoInfo.get(p.groupId);
                info.count++;
                if (p.pago) info.anyPaid = true;
                else info.allPaid = false;
            });

            // Ordenar por n√∫mero para exibi√ß√£o
            const sorted = [...lista].sort((a,b) => a.numero - b.numero);
            let html = ''; // <-- importante: inicializar

            sorted.forEach(p => {
                const info = grupoInfo.get(p.groupId);
                const statusClass = p.pago ? 'status-pago' : 'status-naopago';
                const statusText = p.pago ? 'PAGO' : 'N√ÉO PAGO';
                const dataStr = p.dataPagamento ? new Date(p.dataPagamento).toLocaleDateString('pt-BR') : '‚Äî';
                const multiple = info.count > 1 ? `<span class="group-badge">${info.count} n√∫meros</span>` : '';

                html += `
                    <div class="participant-card" data-groupid="${p.groupId}">
                        <div class="part-row">
                            <span class="part-name">${p.nome} ${multiple}</span>
                            <span class="part-number">#${p.numero}</span>
                        </div>
                        <div class="part-details">
                            <span class="part-status ${statusClass}">${statusText}</span>
                            <span class="part-date">üìÖ ${dataStr}</span>
                        </div>
                        <div class="part-actions">
                            ${!info.allPaid ? `<button class="btn-action pagar" data-groupid="${p.groupId}">üíµ Pagar grupo</button>` : ''}
                            <button class="btn-action recibo" data-groupid="${p.groupId}" ${info.allPaid ? '' : 'disabled style="opacity:0.4;"'}>üßæ Recibo √∫nico</button>
                            <button class="btn-action excluir" data-groupid="${p.groupId}">üóëÔ∏è Excluir grupo</button>
                        </div>
                    </div>
                `;
            });

            participantListDiv.innerHTML = html;

            document.querySelectorAll('.btn-action.pagar').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    marcarPagoGrupo(btn.dataset.groupid);
                });
            });
            document.querySelectorAll('.btn-action.recibo').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    exibirReciboGrupo(btn.dataset.groupid);
                });
            });
            document.querySelectorAll('.btn-action.excluir').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    excluirGrupo(btn.dataset.groupid);
                });
            });
        }

        // --- ATUALIZAR RESUMO ---
        function atualizarResumo() {
            const totalNumeros = participantes.length;
            const totalPago = participantes.filter(p => p.pago).length;
            const arrecadado = totalPago * valorRifa;
            totalNumerosSpan.innerText = totalNumeros;
            totalArrecadadoSpan.innerText = `R$ ${arrecadado.toFixed(2)}`;

            let listaMes = participantes;
            if (filtroMes !== 'todos') {
                const [ano, mes] = filtroMes.split('-').map(Number);
                listaMes = participantes.filter(p => p.pago && p.dataPagamento && new Date(p.dataPagamento).getFullYear() === ano && (new Date(p.dataPagamento).getMonth() + 1) === mes);
                monthLabel.innerText = `m√™s ${mes}/${ano}`;
            } else {
                const hoje = new Date();
                const mesAtual = hoje.getMonth() + 1;
                const anoAtual = hoje.getFullYear();
                listaMes = participantes.filter(p => p.pago && p.dataPagamento && new Date(p.dataPagamento).getFullYear() === anoAtual && (new Date(p.dataPagamento).getMonth() + 1) === mesAtual);
                monthLabel.innerText = 'm√™s atual';
            }
            totalMesSpan.innerText = `R$ ${(listaMes.filter(p => p.pago).length * valorRifa).toFixed(2)}`;
        }

        // --- PREENCHER SELECT DE MESES ---
        function preencherSelectMeses() {
            const mesesSet = new Set();
            participantes.forEach(p => {
                if (p.pago && p.dataPagamento) {
                    const d = new Date(p.dataPagamento);
                    mesesSet.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
                }
            });
            const mesesArray = Array.from(mesesSet).sort().reverse();
            let options = '<option value="todos">Todos os meses</option>';
            mesesArray.forEach(key => {
                const [ano, mes] = key.split('-');
                const nomeMes = new Date(ano, mes-1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                options += `<option value="${key}">${nomeMes}</option>`;
            });
            monthSelect.innerHTML = options;
            if (filtroMes !== 'todos' && mesesArray.includes(filtroMes)) {
                monthSelect.value = filtroMes;
            } else {
                monthSelect.value = 'todos';
                filtroMes = 'todos';
            }
        }

        // --- RENDERIZAR RELAT√ìRIO MENSAL ---
        function renderizarRelatorio() {
            const mesesMap = new Map();
            participantes.forEach(p => {
                if (p.pago && p.dataPagamento) {
                    const d = new Date(p.dataPagamento);
                    const chave = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    if (!mesesMap.has(chave)) {
                        mesesMap.set(chave, {
                            ano: d.getFullYear(),
                            mes: d.getMonth()+1,
                            participantes: [],
                            total: 0
                        });
                    }
                    mesesMap.get(chave).participantes.push(p);
                    mesesMap.get(chave).total += valorRifa;
                }
            });

            if (mesesMap.size === 0) {
                relatorioContainer.innerHTML = '<div class="empty-message">Nenhum pagamento registrado.</div>';
                return;
            }

            const mesesOrdenados = Array.from(mesesMap.entries()).sort((a,b) => b[0].localeCompare(a[0]));

            let html = '';
            for (let [chave, dados] of mesesOrdenados) {
                const nomeMes = new Date(dados.ano, dados.mes-1, 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                html += `
                    <div class="month-block">
                        <div class="month-title">${nomeMes}</div>
                        <div class="month-total">R$ ${dados.total.toFixed(2)}</div>
                        <ul class="month-participants">
                `;
                dados.participantes.sort((a,b) => a.numero - b.numero).forEach(p => {
                    html += `<li><span>#${p.numero} - ${p.nome}</span> <span>R$ ${valorRifa.toFixed(2)}</span></li>`;
                });
                html += `</ul></div>`;
            }
            relatorioContainer.innerHTML = html;
        }

        // --- APLICAR FILTROS E ATUALIZAR TUDO ---
        function aplicarFiltrosEAtualizar() {
            if (abaAtiva === 'participantes') {
                let listaFiltrada = participantes;
                if (termoBusca.trim() !== '') {
                    const termo = termoBusca.toLowerCase();
                    listaFiltrada = listaFiltrada.filter(p => p.nome.toLowerCase().includes(termo));
                }
                if (filtroMes !== 'todos') {
                    const [ano, mes] = filtroMes.split('-').map(Number);
                    listaFiltrada = listaFiltrada.filter(p => {
                        if (!p.pago || !p.dataPagamento) return false;
                        const d = new Date(p.dataPagamento);
                        return d.getFullYear() === ano && (d.getMonth() + 1) === mes;
                    });
                }
                renderizarLista(listaFiltrada);
            }
            atualizarResumo();
            preencherSelectMeses();
        }

        // --- EVENTOS DOS MODAIS ---
        fecharModal.addEventListener('click', () => reciboModal.style.display = 'none');
        btnPdf.addEventListener('click', () => {
            if (reciboAtual) gerarPDFGrupo(reciboAtual);
        });
        window.addEventListener('click', (e) => {
            if (e.target === reciboModal) reciboModal.style.display = 'none';
            if (e.target === participanteModal) participanteModal.style.display = 'none';
        });

        // --- TABS ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                abaAtiva = tab.dataset.tab;
                if (abaAtiva === 'participantes') {
                    tabParticipantes.style.display = 'block';
                    tabRelatorio.style.display = 'none';
                    aplicarFiltrosEAtualizar();
                } else {
                    tabParticipantes.style.display = 'none';
                    tabRelatorio.style.display = 'block';
                    renderizarRelatorio();
                }
            });
        });

        // --- BOT√ÉO ADICIONAR ---
        btnAdicionar.addEventListener('click', () => {
            modalTitle.innerText = '‚ûï Adicionar n√∫meros';
            participanteNomeInput.value = '';
            participanteNumerosInput.value = '';
            participanteModal.style.display = 'flex';
        });

        // --- SALVAR M√öLTIPLOS N√öMEROS ---
        salvarParticipanteBtn.addEventListener('click', async () => {
            const nome = participanteNomeInput.value.trim();
            const numerosTexto = participanteNumerosInput.value.trim();
            if (await salvarMultiplosParticipantes(nome, numerosTexto)) {
                participanteModal.style.display = 'none';
                await carregarParticipantes();
                if (abaAtiva === 'relatorio') renderizarRelatorio();
            }
        });

        cancelarParticipanteBtn.addEventListener('click', () => {
            participanteModal.style.display = 'none';
        });

        // --- SALVAR CONFIGURA√á√ïES ---
        btnSalvarConfig.addEventListener('click', async () => {
            const novoPremio = premioInput.value.trim();
            const novaData = dataSorteioInput.value;
            const novoValor = parseFloat(valorInput.value);

            if (!novoPremio) return alert('Informe o pr√™mio');
            if (!novaData) return alert('Informe a data do sorteio');
            if (isNaN(novoValor) || novoValor <= 0) return alert('Valor inv√°lido');

            premio = novoPremio;
            dataSorteio = novaData;
            valorRifa = novoValor;

            await db.config.put({ chave: 'premio', valor: premio });
            await db.config.put({ chave: 'dataSorteio', valor: dataSorteio });
            await db.config.put({ chave: 'valorRifa', valor: valorRifa });

            atualizarResumo();
            if (abaAtiva === 'relatorio') renderizarRelatorio();
            alert('Configura√ß√µes salvas!');
        });

        // --- FILTROS ---
        searchInput.addEventListener('input', (e) => {
            termoBusca = e.target.value;
            aplicarFiltrosEAtualizar();
        });

        monthSelect.addEventListener('change', (e) => {
            filtroMes = e.target.value;
            aplicarFiltrosEAtualizar();
        });

        // --- INICIALIZA√á√ÉO ---
        await carregarConfig();
        await carregarParticipantes();

        const hoje = new Date().toISOString().split('T')[0];
        dataSorteioInput.min = hoje;
    })();
</script>
</body>
</html>
